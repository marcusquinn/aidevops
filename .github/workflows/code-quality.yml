name: Code Quality Analysis

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  basic-checks:
    name: Basic Quality Checks
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check shell script syntax
      run: |
        echo "Checking shell script syntax..."
        find providers -name "*.sh" -type f | while read file; do
          echo "Checking $file"
          bash -n "$file" || echo "Syntax issue in $file (continuing...)"
        done
      continue-on-error: true

    - name: Validate JSON files
      run: |
        echo "Validating JSON configuration templates..."
        find configs -name "*.json" -type f | while read file; do
          echo "Checking $file"
          python3 -m json.tool "$file" > /dev/null || echo "JSON issue in $file (continuing...)"
        done
      continue-on-error: true

  documentation-check:
    name: Documentation Validation
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check documentation structure
      run: |
        echo "Checking documentation structure..."
        echo "âœ… AGENTS.md exists: $(test -f AGENTS.md && echo 'Yes' || echo 'No')"
        echo "âœ… .agent/ directory exists: $(test -d .agent && echo 'Yes' || echo 'No')"
        echo "âœ… README.md exists: $(test -f README.md && echo 'Yes' || echo 'No')"
        echo "âœ… LICENSE exists: $(test -f LICENSE && echo 'Yes' || echo 'No')"

        echo "Counting documentation files..."
        echo "ðŸ“š Total .md files: $(find . -name '*.md' | wc -l)"
        echo "ðŸ“š Documentation files: $(find docs -name '*.md' 2>/dev/null | wc -l || echo '0')"
        echo "ðŸ“š Provider scripts: $(find providers -name '*.sh' 2>/dev/null | wc -l || echo '0')"
        echo "ðŸ“š Config templates: $(find configs -name '*.txt' 2>/dev/null | wc -l || echo '0')"

  sonarcloud:
    name: SonarCloud Analysis
    runs-on: ubuntu-latest
    if: ${{ secrets.SONAR_TOKEN != '' }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: SonarCloud Scan
      uses: SonarSource/sonarcloud-github-action@master
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      continue-on-error: true
