name: Issue Sync - Bi-directional TODO.md ↔ GitHub Issues

on:
  push:
    branches: [main]
    paths:
      - 'TODO.md'
      - 'todo/PLANS.md'
      - 'todo/tasks/**'
  issues:
    types: [opened]
  workflow_dispatch:
    inputs:
      command:
        description: 'Sync command to run'
        required: true
        default: 'status'
        type: choice
        options:
          - status
          - pull
          - push
          - close
          - reconcile
          - enrich

jobs:
  sync-on-push:
    name: Sync TODO.md → GitHub Issues
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    concurrency:
      group: issue-sync-push-${{ github.ref }}
      cancel-in-progress: true
    permissions:
      contents: write
      issues: write

    steps:
      - name: Check commit author
        id: check-author
        env:
          COMMIT_AUTHOR: ${{ github.event.head_commit.author.name }}
        run: |
          # Prevent infinite loops: skip if this commit was made by GitHub Actions
          # Note: COMMIT_AUTHOR passed via env to prevent shell injection from
          # untrusted input (backticks, $() etc in author names)
          if [[ "$COMMIT_AUTHOR" == "GitHub Actions" ]] || [[ "$COMMIT_AUTHOR" == "github-actions[bot]" ]]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "Skipping: commit was made by GitHub Actions (loop prevention)"
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Checkout
        if: steps.check-author.outputs.skip != 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        if: steps.check-author.outputs.skip != 'true'
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Close issues for completed tasks
        if: steps.check-author.outputs.skip != 'true'
        run: |
          chmod +x .agents/scripts/issue-sync-helper.sh
          chmod +x .agents/scripts/shared-constants.sh
          echo "=== Closing issues for completed tasks ==="
          bash .agents/scripts/issue-sync-helper.sh close --verbose || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Push new tasks as issues
        if: steps.check-author.outputs.skip != 'true'
        run: |
          echo "=== Creating issues for new tasks ==="
          bash .agents/scripts/issue-sync-helper.sh push --verbose || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Enrich plan-linked issues
        if: steps.check-author.outputs.skip != 'true'
        run: |
          echo "=== Enriching plan-linked issues ==="
          bash .agents/scripts/issue-sync-helper.sh enrich --verbose || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull any missing refs back to TODO.md
        if: steps.check-author.outputs.skip != 'true'
        run: |
          echo "=== Pulling issue refs to TODO.md ==="
          bash .agents/scripts/issue-sync-helper.sh pull --verbose || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Commit and push TODO.md updates
        if: steps.check-author.outputs.skip != 'true'
        run: |
          if git diff --quiet TODO.md 2>/dev/null; then
            echo "No TODO.md changes to commit"
          else
            git add TODO.md
            git commit -m "chore: sync GitHub issue refs to TODO.md [skip ci]"
            # Retry loop for concurrent pushes
            for i in 1 2 3; do
              echo "Push attempt $i..."
              git pull --rebase origin main || true
              if git push; then
                echo "Push succeeded on attempt $i"
                exit 0
              fi
              echo "Push failed, retrying..."
              sleep $((i * 3))
            done
            echo "All push attempts failed"
            exit 1
          fi

      - name: Show sync status
        if: steps.check-author.outputs.skip != 'true'
        run: |
          bash .agents/scripts/issue-sync-helper.sh status || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  sync-on-issue:
    name: Sync GitHub Issue → TODO.md
    if: github.event_name == 'issues'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    concurrency:
      group: issue-sync-issue-${{ github.event.issue.number }}
      cancel-in-progress: true
    permissions:
      contents: write
      issues: read

    steps:
      - name: Check issue title format
        id: check-issue
        env:
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          # Note: ISSUE_TITLE passed via env to prevent shell injection from
          # untrusted input (backticks in titles cause `command not found` errors)
          if echo "$ISSUE_TITLE" | grep -qE '^t[0-9]+'; then
            echo "sync=true" >> "$GITHUB_OUTPUT"
            TASK_ID=$(echo "$ISSUE_TITLE" | grep -oE '^t[0-9]+(\.[0-9]+)*')
            echo "task_id=$TASK_ID" >> "$GITHUB_OUTPUT"
            echo "Issue #$ISSUE_NUMBER matches task $TASK_ID"
          else
            echo "sync=false" >> "$GITHUB_OUTPUT"
            echo "Issue #$ISSUE_NUMBER does not have t-number prefix, skipping"
          fi

      - name: Checkout
        if: steps.check-issue.outputs.sync == 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        if: steps.check-issue.outputs.sync == 'true'
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Sync issue ref to TODO.md
        if: steps.check-issue.outputs.sync == 'true'
        run: |
          chmod +x .agents/scripts/issue-sync-helper.sh
          chmod +x .agents/scripts/shared-constants.sh
          echo "=== New issue opened: ${{ steps.check-issue.outputs.task_id }} (#${{ github.event.issue.number }}) ==="
          bash .agents/scripts/issue-sync-helper.sh pull --verbose || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Commit and push TODO.md updates
        if: steps.check-issue.outputs.sync == 'true'
        run: |
          if git diff --quiet TODO.md 2>/dev/null; then
            echo "No TODO.md changes to commit"
          else
            git add TODO.md
            git commit -m "chore: sync ref:GH#${{ github.event.issue.number }} to TODO.md [skip ci]"
            for i in 1 2 3; do
              echo "Push attempt $i..."
              git pull --rebase origin main || true
              if git push; then
                echo "Push succeeded on attempt $i"
                exit 0
              fi
              sleep $((i * 3))
            done
            echo "All push attempts failed"
            exit 1
          fi

  manual-sync:
    name: Manual Sync
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    concurrency:
      group: issue-sync-manual
      cancel-in-progress: false
    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Run sync command
        run: |
          chmod +x .agents/scripts/issue-sync-helper.sh
          chmod +x .agents/scripts/shared-constants.sh
          COMMAND="${{ github.event.inputs.command }}"
          echo "=== Running: issue-sync-helper.sh $COMMAND ==="
          bash .agents/scripts/issue-sync-helper.sh "$COMMAND" --verbose
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Commit and push TODO.md updates
        if: github.event.inputs.command == 'pull' || github.event.inputs.command == 'push'
        run: |
          if git diff --quiet TODO.md 2>/dev/null; then
            echo "No TODO.md changes to commit"
          else
            git add TODO.md
            git commit -m "chore: manual issue sync (${{ github.event.inputs.command }}) [skip ci]"
            for i in 1 2 3; do
              git pull --rebase origin main || true
              if git push; then
                exit 0
              fi
              sleep $((i * 3))
            done
            exit 1
          fi
