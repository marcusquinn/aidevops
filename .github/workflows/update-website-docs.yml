name: Update Website Docs

on:
  release:
    types: [published]
  push:
    branches: [main]
    paths:
      - 'README.md'
  workflow_dispatch:

jobs:
  update-docs:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout aidevops repo
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install marked (Markdown parser)
        run: bun install marked

      - name: Convert README to HTML
        run: |
          # Create conversion script using ES modules
          cat > convert.mjs << 'EOF'
          import { marked } from 'marked';
          import fs from 'fs';

          // Configure marked for GitHub-flavored markdown
          marked.setOptions({
            gfm: true,
            breaks: false
          });

          let readme = fs.readFileSync('README.md', 'utf8');
          
          // Convert relative links to absolute GitHub URLs
          // Matches markdown links like [text](.agent/file.md) or [text](LICENSE)
          const repoBase = 'https://github.com/marcusquinn/aidevops/blob/main/';
          readme = readme.replace(/\]\((?!http|#|mailto:)([^)]+)\)/g, (match, path) => {
            return `](${repoBase}${path})`;
          });
          
          const content = marked.parse(readme);

          // Output just the content
          console.log(content);
          EOF

          node convert.mjs > readme_content.html

      - name: Generate docs.html
        run: |
          cat > docs.html << 'HEADER'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              
              <!-- Primary Meta Tags -->
              <title>AIDevOps Documentation - AI DevOps Framework Setup &amp; Configuration Guide</title>
              <meta name="title" content="AIDevOps Documentation - AI DevOps Framework Setup & Configuration Guide">
              <meta name="description" content="Complete AIDevOps documentation: setup guide, MCP server configuration, service integrations, AI assistant compatibility, and DevOps automation tutorials for the AI DevOps framework.">
              <meta name="keywords" content="ai devops documentation, aidevops guide, ai devops setup, mcp server configuration, ai assistant devops, devops framework docs, ai infrastructure guide, aidevops tutorial">
              <meta name="author" content="Marcus Quinn">
              <meta name="robots" content="index, follow">
              <link rel="canonical" href="https://aidevops.sh/docs.html">
              
              <!-- Open Graph / Facebook -->
              <meta property="og:type" content="article">
              <meta property="og:url" content="https://aidevops.sh/docs.html">
              <meta property="og:title" content="AIDevOps Documentation - Setup & Configuration Guide">
              <meta property="og:description" content="Complete AIDevOps documentation: setup guide, MCP server configuration, service integrations, AI assistant compatibility, and DevOps automation tutorials.">
              <meta property="og:image" content="https://aidevops.sh/og-image.png">
              <meta property="og:site_name" content="AI DevOps">
              <meta property="og:locale" content="en_US">
              <meta property="og:logo" content="https://aidevops.sh/og-image.png">
              
              <!-- Twitter -->
              <meta name="twitter:card" content="summary_large_image">
              <meta name="twitter:url" content="https://aidevops.sh/docs.html">
              <meta name="twitter:title" content="AIDevOps Documentation - Setup & Configuration Guide">
              <meta name="twitter:description" content="Complete AIDevOps documentation: setup guide, MCP server configuration, service integrations, AI assistant compatibility, and DevOps automation tutorials.">
              <meta name="twitter:image" content="https://aidevops.sh/og-image.png">
              <meta name="twitter:creator" content="@marcuswquinn">
              
              <!-- Additional SEO -->
              <meta name="theme-color" content="#B2E969">
              <meta name="apple-mobile-web-app-title" content="AI DevOps Docs">
              <meta name="application-name" content="AI DevOps">
              
              <link rel="stylesheet" href="styles.css">
              <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 576 512'><path fill='%23B2E969' d='M9.4 86.6C-3.1 74.1-3.1 53.9 9.4 41.4s32.8-12.5 45.3 0l192 192c12.5 12.5 12.5 32.8 0 45.3l-192 192c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L178.7 256 9.4 86.6zM256 416H544c17.7 0 32 14.3 32 32s-14.3 32-32 32H256c-17.7 0-32-14.3-32-32s14.3-32 32-32z'/></svg>">
              
              <!-- JSON-LD Structured Data -->
              <script type="application/ld+json">
              {
                  "@context": "https://schema.org",
                  "@type": "TechArticle",
                  "@id": "https://aidevops.sh/docs.html#article",
                  "headline": "AIDevOps Framework Documentation",
                  "description": "Complete documentation for the AIDevOps framework - setup guide, MCP server configuration, service integrations, and DevOps automation tutorials.",
                  "url": "https://aidevops.sh/docs.html",
                  "author": {
                      "@type": "Person",
                      "name": "Marcus Quinn",
                      "url": "https://x.com/marcuswquinn"
                  },
                  "publisher": {
                      "@type": "Organization",
                      "name": "AI DevOps",
                      "url": "https://aidevops.sh/"
                  },
                  "mainEntityOfPage": {
                      "@type": "WebPage",
                      "@id": "https://aidevops.sh/docs.html"
                  },
                  "about": {
                      "@type": "SoftwareApplication",
                      "name": "AIDevOps Framework",
                      "applicationCategory": "DeveloperApplication"
                  },
                  "keywords": "ai devops, aidevops, documentation, setup guide, mcp servers, devops automation"
              }
              </script>
          </head>
          <body class="docs-page">
              <nav class="nav">
                  <div class="nav-container">
                      <a href="/" class="nav-logo"><svg class="nav-logo-icon" viewBox="0 0 576 512" width="20" height="20"><path fill="currentColor" d="M9.4 86.6C-3.1 74.1-3.1 53.9 9.4 41.4s32.8-12.5 45.3 0l192 192c12.5 12.5 12.5 32.8 0 45.3l-192 192c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L178.7 256 9.4 86.6zM256 416H544c17.7 0 32 14.3 32 32s-14.3 32-32 32H256c-17.7 0-32-14.3-32-32s14.3-32 32-32z"/></svg>aidevops</a>
                      <div class="nav-links">
                          <a href="docs.html" class="nav-link">Docs</a>
                          <a href="https://github.com/marcusquinn/aidevops" target="_blank" rel="noopener noreferrer" class="btn-nav" aria-label="View on GitHub">
                              <span class="btn-icon-left">
                                  <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                                      <path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"/>
                                  </svg>
                              </span>
                              <span class="btn-text">GitHub</span>
                              <span class="btn-icon-right">
                                  <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                      <path d="M4.5 12h15m0 0l-6.75-6.75M19.5 12l-6.75 6.75"/>
                                  </svg>
                              </span>
                          </a>
                          <a href="https://x.com/marcuswquinn" target="_blank" rel="noopener noreferrer" class="nav-icon" aria-label="X/Twitter">
                              <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                                  <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                              </svg>
                          </a>
                          <button class="theme-toggle" id="themeToggle" aria-label="Toggle theme">
                              <svg class="sun-icon" viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                                  <circle cx="12" cy="12" r="5"/>
                                  <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
                              </svg>
                              <svg class="moon-icon" viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                                  <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/>
                              </svg>
                          </button>
                      </div>
                  </div>
              </nav>

              <main class="docs-container">
                  <div class="docs-content">
          HEADER

          # Append converted markdown
          cat readme_content.html >> docs.html

          # Append footer
          cat >> docs.html << 'FOOTER'
                      <div class="back-to-top">
                          <a href="#">Back to top</a>
                      </div>
                  </div>
              </main>

              <footer class="footer">
                  <div class="container">
                      <p>Powered and inspired by <a href="https://opencode.ai" target="_blank" rel="noopener noreferrer">OpenCode</a>, <a href="https://tabby.sh" target="_blank" rel="noopener noreferrer">Tabby</a>, and <a href="https://zed.dev" target="_blank" rel="noopener noreferrer">Zed</a></p>
                      <p class="copyright">MIT License - Created by Marcus Quinn</p>
                  </div>
              </footer>

              <script src="script.js"></script>
          </body>
          </html>
          FOOTER

      - name: Checkout website repo
        uses: actions/checkout@v4
        with:
          repository: marcusquinn/aidevops.sh
          path: website
          token: ${{ secrets.WEBSITE_PAT }}

      - name: Update docs.html in website repo
        run: |
          cp docs.html website/docs.html
          cd website
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Check if there are changes
          if git diff --quiet docs.html 2>/dev/null; then
            echo "No changes to docs.html"
            exit 0
          fi
          
          git add docs.html
          git commit -m "docs: sync from aidevops README.md

          Auto-generated from marcusquinn/aidevops README.md
          Triggered by: ${{ github.event_name }}
          Source commit: ${{ github.sha }}"
          
          # Pull with rebase to handle concurrent pushes, then push
          git pull --rebase origin main || true
          git push

      - name: Summary
        run: |
          echo "## Docs Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Source: \`marcusquinn/aidevops/README.md\`" >> $GITHUB_STEP_SUMMARY
          echo "- Target: \`marcusquinn/aidevops.sh/docs.html\`" >> $GITHUB_STEP_SUMMARY
          echo "- Trigger: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
