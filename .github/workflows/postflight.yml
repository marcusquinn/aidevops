name: Postflight Verification

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to verify (leave empty for latest)'
        required: false

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  postflight:
    name: Verify Release Health
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    permissions:
      contents: read
      checks: read
      security-events: read
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.inputs.tag || github.ref }}
        fetch-depth: 0
    
    - name: Setup Bun
      uses: oven-sh/setup-bun@v2
      with:
        bun-version: latest
    
    - name: Wait for CI/CD Pipelines
      run: |
        echo "Waiting for all check runs to complete..."
        echo "Note: Excluding this workflow (Verify Release Health) to avoid circular dependency"
        sleep 60  # Initial wait for workflows to start
        
        # Poll for completion, excluding this workflow to avoid circular dependency
        SELF_NAME="Verify Release Health"
        for i in {1..20}; do
          PENDING=$(gh api repos/${{ github.repository }}/commits/${{ github.sha }}/check-runs \
            --jq "[.check_runs[] | select(.status != \"completed\" and .name != \"$SELF_NAME\")] | length")
          
          if [[ "$PENDING" == "0" ]]; then
            echo "All check runs completed (excluding self)"
            break
          fi
          
          # Show which workflows are still pending
          echo "Waiting for $PENDING check runs... (attempt $i/20)"
          gh api repos/${{ github.repository }}/commits/${{ github.sha }}/check-runs \
            --jq ".check_runs[] | select(.status != \"completed\" and .name != \"$SELF_NAME\") | \"  - \(.name): \(.status)\"" || true
          sleep 30
        done
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Verify CI/CD Status
      id: cicd
      run: |
        echo "## CI/CD Pipeline Status" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Get all check runs, excluding self to avoid counting our own status
        SELF_NAME="Verify Release Health"
        CHECK_RUNS=$(gh api repos/${{ github.repository }}/commits/${{ github.sha }}/check-runs \
          --jq ".check_runs[] | select(.name != \"$SELF_NAME\") | {name, status, conclusion}")
        
        # Count results (excluding self)
        TOTAL=$(echo "$CHECK_RUNS" | jq -s 'length')
        PASSED=$(echo "$CHECK_RUNS" | jq -s '[.[] | select(.conclusion == "success")] | length')
        SKIPPED=$(echo "$CHECK_RUNS" | jq -s '[.[] | select(.conclusion == "skipped")] | length')
        FAILED=$(echo "$CHECK_RUNS" | jq -s '[.[] | select(.conclusion == "failure")] | length')
        
        echo "| Check | Status | Conclusion |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|------------|" >> $GITHUB_STEP_SUMMARY
        
        # Show all check runs including self for transparency
        gh api repos/${{ github.repository }}/commits/${{ github.sha }}/check-runs \
          --jq '.check_runs[] | "| \(.name) | \(.status) | \(.conclusion // "pending") |"' >> $GITHUB_STEP_SUMMARY
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "*Note: 'Verify Release Health' (this workflow) is excluded from pass/fail counts*" >> $GITHUB_STEP_SUMMARY
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Total**: $TOTAL | **Passed**: $PASSED | **Skipped**: $SKIPPED | **Failed**: $FAILED" >> $GITHUB_STEP_SUMMARY
        
        # Separate critical workflow failures from advisory tool failures
        # Critical: core CI checks (Security Validation, Framework Validation, Version Consistency)
        # Advisory: external analysis tools that fail intermittently (non-blocking)
        # Pipe-delimited list of exact check names to treat as advisory
        ADVISORY_NAMES="SonarCloud Code Analysis"
        
        CRITICAL_FAILED=$(echo "$CHECK_RUNS" | jq -s --arg names "$ADVISORY_NAMES" \
          '($names | split("|")) as $adv |
           [.[] | select(.conclusion == "failure") | select(.name as $n | $adv | index($n) | not)] | length')
        ADVISORY_FAILED=$(echo "$CHECK_RUNS" | jq -s --arg names "$ADVISORY_NAMES" \
          '($names | split("|")) as $adv |
           [.[] | select(.conclusion == "failure") | select(.name as $n | $adv | index($n))] | length')
        
        if [[ "$ADVISORY_FAILED" != "0" ]]; then
          echo "::warning::$ADVISORY_FAILED advisory check(s) failed (non-blocking)"
          echo "$CHECK_RUNS" | jq -rs --arg names "$ADVISORY_NAMES" \
            '($names | split("|")) as $adv |
             .[] | select(.conclusion == "failure") | select(.name as $n | $adv | index($n)) | "  Advisory failure: \(.name)"'
        fi
        
        if [[ "$CRITICAL_FAILED" != "0" ]]; then
          echo "::error::$CRITICAL_FAILED critical check run(s) failed"
          echo "$CHECK_RUNS" | jq -rs --arg names "$ADVISORY_NAMES" \
            '($names | split("|")) as $adv |
             .[] | select(.conclusion == "failure") | select(.name as $n | $adv | index($n) | not) | "  Critical failure: \(.name)"'
          echo "cicd_status=failed" >> $GITHUB_OUTPUT
          exit 1
        fi
        
        if [[ "$ADVISORY_FAILED" != "0" ]]; then
          echo "cicd_status=warning" >> $GITHUB_OUTPUT
        else
          echo "cicd_status=passed" >> $GITHUB_OUTPUT
        fi
        echo "CI/CD critical checks passed"
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Check SonarCloud Quality Gate
      if: always()
      id: sonarcloud
      run: |
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## SonarCloud Analysis" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Get quality gate status
        QG_RESPONSE=$(curl -s "https://sonarcloud.io/api/qualitygates/project_status?projectKey=marcusquinn_aidevops")
        STATUS=$(echo "$QG_RESPONSE" | jq -r '.projectStatus.status // "UNKNOWN"')
        
        echo "**Quality Gate**: $STATUS" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Get metrics
        METRICS=$(curl -s "https://sonarcloud.io/api/measures/component?component=marcusquinn_aidevops&metricKeys=bugs,vulnerabilities,code_smells,security_hotspots")
        
        echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "$METRICS" | jq -r '.component.measures[] | "| \(.metric) | \(.value) |"' >> $GITHUB_STEP_SUMMARY 2>/dev/null || true
        
        if [[ "$STATUS" == "ERROR" ]]; then
          echo "::warning::SonarCloud quality gate failed"
          echo "sonar_status=failed" >> $GITHUB_OUTPUT
        elif [[ "$STATUS" == "OK" ]]; then
          echo "sonar_status=passed" >> $GITHUB_OUTPUT
        else
          echo "sonar_status=unknown" >> $GITHUB_OUTPUT
        fi
      continue-on-error: true
    
    - name: Security Scan with Snyk
      if: always()
      id: snyk
      run: |
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Security Scan (Snyk)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Install Snyk (Bun for faster install)
        bun install -g snyk
        
        # Authenticate if token available
        if [[ -n "${{ secrets.SNYK_TOKEN }}" ]]; then
          snyk auth ${{ secrets.SNYK_TOKEN }}
          
          # Run security scan
          if snyk test --severity-threshold=high --json > snyk-results.json 2>/dev/null; then
            echo "**Status**: No high/critical vulnerabilities found" >> $GITHUB_STEP_SUMMARY
            echo "snyk_status=passed" >> $GITHUB_OUTPUT
          else
            VULN_COUNT=$(jq '.vulnerabilities | length // 0' snyk-results.json)
            echo "**Status**: $VULN_COUNT vulnerabilities found" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Severity | Package | Title |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|---------|-------|" >> $GITHUB_STEP_SUMMARY
            jq -r '.vulnerabilities[:5][] | "| \(.severity) | \(.packageName) | \(.title) |"' snyk-results.json >> $GITHUB_STEP_SUMMARY 2>/dev/null || true
            echo "snyk_status=issues" >> $GITHUB_OUTPUT
          fi
        else
          echo "**Status**: Skipped (SNYK_TOKEN not configured)" >> $GITHUB_STEP_SUMMARY
          echo "snyk_status=skipped" >> $GITHUB_OUTPUT
        fi
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      continue-on-error: true
    
    - name: Check for Secrets
      if: always()
      id: secrets
      run: |
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Secret Detection (Secretlint)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Install secretlint (Bun for faster install)
        bun install -g secretlint @secretlint/secretlint-rule-preset-recommend
        
        # Run scan
        if secretlint "**/*" --format compact 2>/dev/null; then
          echo "**Status**: No secrets detected" >> $GITHUB_STEP_SUMMARY
          echo "secrets_status=passed" >> $GITHUB_OUTPUT
        else
          echo "**Status**: Potential secrets detected" >> $GITHUB_STEP_SUMMARY
          echo "::error::Potential secrets detected in codebase"
          echo "secrets_status=failed" >> $GITHUB_OUTPUT
        fi
      continue-on-error: true
    
    - name: Generate Final Report
      id: report
      if: always()
      run: |
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Postflight Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        CICD="${{ steps.cicd.outputs.cicd_status }}"
        SONAR="${{ steps.sonarcloud.outputs.sonar_status }}"
        SNYK="${{ steps.snyk.outputs.snyk_status }}"
        SECRETS="${{ steps.secrets.outputs.secrets_status }}"
        
        # Default unset outputs to 'skipped' (step didn't produce output)
        CICD="${CICD:-skipped}"
        SONAR="${SONAR:-skipped}"
        SNYK="${SNYK:-skipped}"
        SECRETS="${SECRETS:-skipped}"
        
        echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| CI/CD Pipelines | ${CICD} |" >> $GITHUB_STEP_SUMMARY
        echo "| SonarCloud | ${SONAR} |" >> $GITHUB_STEP_SUMMARY
        echo "| Snyk Security | ${SNYK} |" >> $GITHUB_STEP_SUMMARY
        echo "| Secret Detection | ${SECRETS} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Release**: ${{ github.event.release.tag_name || github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "**Time**: $(date -u)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "*Generated by AI DevOps Framework Postflight Verification*" >> $GITHUB_STEP_SUMMARY
        
        # Determine overall result
        # Critical failures: CI/CD hard failures or secrets detected
        HAS_CRITICAL=false
        HAS_WARNING=false
        
        if [[ "$CICD" == "failed" ]]; then
          HAS_CRITICAL=true
        fi
        if [[ "$SECRETS" == "failed" ]]; then
          HAS_CRITICAL=true
        fi
        
        # Warnings: advisory failures, SonarCloud issues, Snyk issues
        if [[ "$CICD" == "warning" || "$SONAR" == "failed" || "$SNYK" == "issues" ]]; then
          HAS_WARNING=true
        fi
        
        if [[ "$HAS_CRITICAL" == "true" ]]; then
          echo "::error::Postflight verification failed for release ${{ github.event.release.tag_name || github.ref_name }}"
          echo ""
          echo "Recommended actions:"
          echo "1. Review the failed checks in the workflow summary"
          echo "2. If critical issues found, consider rollback"
          echo "3. See: .agents/workflows/postflight.md#rollback-procedures"
          exit 1
        elif [[ "$HAS_WARNING" == "true" ]]; then
          echo "::warning::Postflight completed with warnings for release ${{ github.event.release.tag_name || github.ref_name }}"
          echo "Review advisory warnings above and address in next release if needed."
        else
          echo "Postflight verification passed for release ${{ github.event.release.tag_name || github.ref_name }}"
        fi
