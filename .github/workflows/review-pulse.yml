name: Daily Review Pulse

on:
  schedule:
    # Run daily at 3 AM UTC
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      severity:
        description: 'Minimum severity level'
        required: false
        default: 'medium'
        type: choice
        options:
          - critical
          - high
          - medium
          - low
          - info

# Cancel in-progress runs when a new run is triggered
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  review-pulse:
    name: CodeRabbit Full Codebase Review
    runs-on: ubuntu-latest

    permissions:
      contents: read
      issues: write

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install CodeRabbit CLI
      run: |
        curl -fsSL https://cli.coderabbit.ai/install.sh | sh
        coderabbit --version

    - name: Install Dependencies
      run: |
        sudo apt-get update && sudo apt-get install -y jq

    - name: Run Review Pulse
      env:
        CODERABBIT_API_KEY: ${{ secrets.CODERABBIT_API_KEY }}
      run: |
        chmod +x .agents/scripts/*.sh

        SEVERITY="${{ github.event.inputs.severity || 'medium' }}"

        .agents/scripts/review-pulse-helper.sh run --severity "$SEVERITY"

    - name: Show Findings
      if: always()
      run: |
        .agents/scripts/review-pulse-helper.sh findings --format text || true

    - name: Generate Task Suggestions
      if: always()
      run: |
        .agents/scripts/review-pulse-helper.sh tasks --dry-run || true

    - name: Auto-Create Tasks from Findings (t166.3)
      if: always()
      run: |
        chmod +x .agents/scripts/coderabbit-task-creator-helper.sh 2>/dev/null || true
        .agents/scripts/coderabbit-task-creator-helper.sh create --source pulse --dry-run || true
        .agents/scripts/coderabbit-task-creator-helper.sh stats || true

    - name: Upload Findings Artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: review-pulse-findings-${{ github.run_number }}
        path: ~/.aidevops/.agent-workspace/work/review-pulse/findings/
        retention-days: 30
        if-no-files-found: ignore

    - name: Summary
      if: always()
      run: |
        echo "## Daily Review Pulse Complete" >> "$GITHUB_STEP_SUMMARY"
        echo "" >> "$GITHUB_STEP_SUMMARY"

        FINDINGS_DIR="${HOME}/.aidevops/.agent-workspace/work/review-pulse/findings"
        LATEST=$(ls -t "$FINDINGS_DIR"/*-findings.json 2>/dev/null | head -1 || echo "")

        if [[ -n "$LATEST" && -f "$LATEST" ]]; then
          TOTAL=$(jq '.stats.total_parsed // 0' "$LATEST")
          FINAL=$(jq '.stats.final_findings // 0' "$LATEST")
          FP=$(jq '.stats.false_positives_removed // 0' "$LATEST")

          echo "| Metric | Count |" >> "$GITHUB_STEP_SUMMARY"
          echo "|--------|-------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Total parsed | $TOTAL |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Final findings | $FINAL |" >> "$GITHUB_STEP_SUMMARY"
          echo "| False positives filtered | $FP |" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          # Show critical/high findings in summary
          CRITICAL=$(jq '[(.findings // [])[] | select(.severity == "critical")] | length' "$LATEST")
          HIGH=$(jq '[(.findings // [])[] | select(.severity == "high")] | length' "$LATEST")

          if [[ "$CRITICAL" -gt 0 || "$HIGH" -gt 0 ]]; then
            echo "### Findings Requiring Attention" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            jq -r '.findings[] | select(.severity == "critical" or .severity == "high") | "- **\(.severity)**: \(.file) - \(.description[0:100])"' "$LATEST" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "No critical or high severity findings." >> "$GITHUB_STEP_SUMMARY"
          fi
        else
          echo "No findings file generated." >> "$GITHUB_STEP_SUMMARY"
        fi

        echo "" >> "$GITHUB_STEP_SUMMARY"
        echo "*Generated by AI DevOps Review Pulse*" >> "$GITHUB_STEP_SUMMARY"
