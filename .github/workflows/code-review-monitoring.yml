name: ðŸ” Code Review Monitoring & Auto-Fix

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

# Cancel in-progress runs when a new run is triggered
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  code-review-monitoring:
    name: ðŸ¤– Monitor & Auto-Fix Code Quality
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
      security-events: write
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ðŸ”§ Setup Bun
      uses: oven-sh/setup-bun@v2
      with:
        bun-version: latest
    
    - name: ðŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: ðŸ“¦ Install Dependencies
      run: |
        # Install jq for JSON processing
        sudo apt-get update && sudo apt-get install -y jq curl
        
        # Install TOON CLI (Bun for faster install)
        bun install -g @toon-format/cli
        
        # Install Python dependencies for quality tools
        pip install --upgrade pip pyyaml
    
    - name: ðŸ” Install Quality Tools
      run: |
        # Install Qlty CLI
        curl -sSL https://github.com/qltysh/qlty/releases/latest/download/qlty-x86_64-unknown-linux-gnu.tar.xz -o qlty.tar.xz
        tar xf qlty.tar.xz
        sudo mv qlty-*/qlty /usr/local/bin/
        rm -rf qlty*
        
        # Install Codacy CLI
        curl -L https://github.com/codacy/codacy-analysis-cli/releases/latest/download/codacy-analysis-cli-linux -o codacy-analysis-cli
        chmod +x codacy-analysis-cli
        sudo mv codacy-analysis-cli /usr/local/bin/
    
    - name: ðŸƒ Run Code Review Monitoring
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        CODACY_PROJECT_TOKEN: ${{ secrets.CODACY_PROJECT_TOKEN }}
      run: |
        # Make scripts executable
        chmod +x .agents/scripts/*.sh
        
        # Run monitoring with full analysis
        ./.agents/scripts/monitor-code-review.sh monitor
    
    - name: ðŸ”§ Apply Auto-Fixes
      run: |
        # NOTE: Qlty fmt disabled - it introduces invalid shell syntax
        # (adds "|| exit" after "then" in if statements)
        # See: https://github.com/marcusquinn/aidevops/issues/333
        
        # Apply framework-specific fixes only
        ./.agents/scripts/monitor-code-review.sh fix
    
    - name: ðŸ“Š Generate Quality Report
      run: |
        # Generate comprehensive quality report
        ./.agents/scripts/monitor-code-review.sh report > quality-report.md
        
        # Add current metrics
        echo "## ðŸ“ˆ Current Quality Metrics" >> quality-report.md
        echo "" >> quality-report.md
        
        # SonarCloud metrics
        if curl -s "https://sonarcloud.io/api/measures/component?component=marcusquinn_aidevops&metricKeys=bugs,vulnerabilities,code_smells" | jq -r '.component.measures[] | "- **\(.metric | gsub("_"; " ") | ascii_upcase)**: \(.value)"' >> quality-report.md 2>/dev/null; then
          echo "SonarCloud metrics added"
        fi
        
        echo "" >> quality-report.md
        echo "Generated on: $(date)" >> quality-report.md
    
    - name: ðŸ“¤ Upload Quality Report
      uses: actions/upload-artifact@v4
      with:
        name: quality-report
        path: quality-report.md
        retention-days: 30
    
    - name: ðŸ“¤ Upload SARIF Results
      if: always() && hashFiles('codacy-results.sarif') != ''
      uses: github/codeql-action/upload-sarif@v4
      with:
        sarif_file: codacy-results.sarif
        category: codacy
      continue-on-error: true
    
    - name: Validate Auto-Fixes
      id: validate
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        # Check if there are any changes to validate
        if git diff --quiet; then
          echo "No changes to validate"
          echo "has_changes=false" >> "$GITHUB_OUTPUT"
          exit 0
        fi

        errors=0
        reverted_files=""

        # Validate each modified file by type
        for file in $(git diff --name-only); do
          case "$file" in
            *.sh)
              # ShellCheck validation (error severity)
              if ! shellcheck -S error "$file" 2>/dev/null; then
                echo "FAIL: ShellCheck rejected $file"
                git checkout -- "$file"
                reverted_files="$reverted_files $file"
                errors=$((errors + 1))
              # Bash syntax check
              elif ! bash -n "$file" 2>/dev/null; then
                echo "FAIL: bash -n syntax check rejected $file"
                git checkout -- "$file"
                reverted_files="$reverted_files $file"
                errors=$((errors + 1))
              else
                echo "OK: $file passed validation"
              fi
              ;;
            *.json)
              if ! python3 -m json.tool "$file" > /dev/null 2>&1; then
                echo "FAIL: Invalid JSON in $file"
                git checkout -- "$file"
                reverted_files="$reverted_files $file"
                errors=$((errors + 1))
              else
                echo "OK: $file passed validation"
              fi
              ;;
            *.yml|*.yaml)
              if ! python3 -c "import yaml; yaml.safe_load(open('$file'))" 2>/dev/null; then
                echo "FAIL: Invalid YAML in $file"
                git checkout -- "$file"
                reverted_files="$reverted_files $file"
                errors=$((errors + 1))
              else
                echo "OK: $file passed validation"
              fi
              ;;
            *)
              echo "OK: $file (no specific validator)"
              ;;
          esac
        done

        if [[ $errors -gt 0 ]]; then
          echo "::warning::Reverted $errors file(s) that failed validation:$reverted_files"
        fi

        # After reverting bad files, check if valid changes remain
        if git diff --quiet; then
          echo "All changes failed validation and were reverted"
          echo "has_changes=false" >> "$GITHUB_OUTPUT"
        else
          remaining=$(git diff --name-only | wc -l | tr -d ' ')
          echo "Validated changes ready for PR ($remaining file(s) passed)"
          echo "has_changes=true" >> "$GITHUB_OUTPUT"
        fi

    - name: Create Auto-Fix PR
      if: github.event_name == 'push' && github.ref == 'refs/heads/main' && steps.validate.outputs.has_changes == 'true'
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

        BRANCH="auto-fix/quality-$(date +%Y%m%d-%H%M%S)"
        git checkout -b "$BRANCH"
        git add .
        git commit -m "fix: apply validated code quality improvements

        Automated fixes applied by Code Review Monitoring workflow.
        All changes passed validation (ShellCheck, syntax, JSON/YAML).

        Generated by: GitHub Actions Code Review Monitoring"

        git push origin "$BRANCH"

        # Create PR for review
        gh pr create \
          --title "fix: auto-fix code quality improvements" \
          --body "## Automated Code Quality Fixes

        Changes applied by the Code Review Monitoring workflow.

        ### Safety Checks Passed
        - ShellCheck (error severity) on all \`.sh\` files
        - \`bash -n\` syntax validation on all \`.sh\` files
        - JSON schema validation on all \`.json\` files
        - YAML syntax validation on all \`.yml\`/\`.yaml\` files

        Files that failed validation were **automatically reverted** and excluded.

        ---
        *Generated by GitHub Actions Code Review Monitoring*" \
          --base main \
          --head "$BRANCH"

        echo "Auto-fix PR created on branch $BRANCH"
    
    - name: ðŸ“ Comment on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          if (fs.existsSync('quality-report.md')) {
            const report = fs.readFileSync('quality-report.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸ” Code Quality Report\n\n${report}\n\n---\n*Generated by AI DevOps Framework Code Review Monitoring*`
            });
          }
    
    - name: ðŸŽ¯ Summary
      run: |
        echo "## ðŸŽ‰ Code Review Monitoring Complete!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š Quality Status:" >> $GITHUB_STEP_SUMMARY
        
        # Add SonarCloud status
        if curl -s "https://sonarcloud.io/api/measures/component?component=marcusquinn_aidevops&metricKeys=bugs,vulnerabilities,code_smells" | jq -r '"- **Bugs**: " + (.component.measures[] | select(.metric=="bugs") | .value) + "\n- **Vulnerabilities**: " + (.component.measures[] | select(.metric=="vulnerabilities") | .value) + "\n- **Code Smells**: " + (.component.measures[] | select(.metric=="code_smells") | .value)' >> $GITHUB_STEP_SUMMARY 2>/dev/null; then
          echo "Quality metrics added to summary"
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ› ï¸ Tools Used:" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… SonarCloud Analysis" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Codacy Analysis with Auto-Fix" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Qlty Universal Linting" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… TOON Format Integration" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "*Automated by AI DevOps Framework v1.5.0*" >> $GITHUB_STEP_SUMMARY
