name: Version Validation

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  version-consistency:
    name: Version Consistency Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Version Consistency Validation
      run: |
        echo "ðŸ” AI DevOps Framework - Version Consistency Validation"
        echo "====================================================="
        echo ""
        
        # Make validation script executable
        chmod +x .agent/scripts/validate-version-consistency.sh
        
        # Run version validation
        if ./.agent/scripts/validate-version-consistency.sh; then
          echo ""
          echo "âœ… Version Validation: PASSED"
          echo "All version references are consistent across the framework."
        else
          echo ""
          echo "âŒ Version Validation: FAILED"
          echo "Version inconsistencies detected. Please fix before merging."
          exit 1
        fi

    - name: Version Information Summary
      run: |
        echo ""
        echo "ðŸ“Š Version Information Summary"
        echo "=============================="
        
        # Get current version
        if [ -f "VERSION" ]; then
          CURRENT_VERSION=$(cat VERSION)
          echo "ðŸ“¦ Current Version: $CURRENT_VERSION"
        else
          echo "âš ï¸  VERSION file not found"
        fi
        
        # Check README badge
        if [ -f "README.md" ]; then
          README_VERSION=$(grep -o "Version-[0-9]\+\.[0-9]\+\.[0-9]\+-blue" README.md | head -1 || echo "not found")
          echo "ðŸ·ï¸  README Badge: $README_VERSION"
        fi
        
        # Check sonar properties
        if [ -f "sonar-project.properties" ]; then
          SONAR_VERSION=$(grep "sonar.projectVersion=" sonar-project.properties | cut -d'=' -f2 || echo "not found")
          echo "ðŸ” SonarCloud Version: $SONAR_VERSION"
        fi
        
        # Check setup script
        if [ -f "setup.sh" ]; then
          SETUP_VERSION=$(grep "# Version:" setup.sh | cut -d':' -f2 | xargs || echo "not found")
          echo "âš™ï¸  Setup Script Version: $SETUP_VERSION"
        fi
        
        echo ""
        echo "ðŸŽ¯ Version validation ensures consistency across all framework components."

    - name: Release Readiness Check
      if: github.ref == 'refs/heads/main'
      id: release-readiness
      env:
        COMMIT_MSG: ${{ github.event.head_commit.message }}
      run: |
        echo ""
        echo "ðŸš€ Release Readiness Assessment"
        echo "==============================="
        
        # Check if this is a potential release commit
        echo "ðŸ“ Commit Message: $COMMIT_MSG"
        
        # Check for version bump indicators
        if echo "$COMMIT_MSG" | grep -qE "(BREAKING|MAJOR|ðŸ’¥|ðŸš¨)"; then
          echo "ðŸ”´ MAJOR version bump detected"
        elif echo "$COMMIT_MSG" | grep -qE "(FEATURE|FEAT|NEW|ADD|âœ¨|ðŸš€|ðŸ“¦)"; then
          echo "ðŸŸ¡ MINOR version bump detected"
        elif echo "$COMMIT_MSG" | grep -qE "(FIX|PATCH|BUG|IMPROVE|UPDATE|ðŸ”§|ðŸ›|ðŸ“)"; then
          echo "ðŸŸ¢ PATCH version bump detected"
        else
          echo "âšª No version bump indicators found"
        fi
        
        echo ""
        echo "ðŸ’¡ To create a release:"
        echo "   ./.agent/scripts/version-manager.sh release [major|minor|patch]"
        echo ""
        echo "âœ… Framework is ready for release when version validation passes."

    - name: Automated Release Check
      if: github.ref == 'refs/heads/main'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "ðŸš§ Automated Release Check"
        echo "=========================="
        
        if [ -f "VERSION" ]; then
           CURRENT_VERSION="v$(cat VERSION)"
           echo "Target Version: $CURRENT_VERSION"
           
           if git rev-parse "$CURRENT_VERSION" >/dev/null 2>&1; then
             echo "âœ… Tag $CURRENT_VERSION already exists"
           else
             echo "âœ¨ Ready to release $CURRENT_VERSION"
             echo "   (Use version-manager.sh to trigger release)"
           fi
        fi
